package hh.harkkas23v01.web;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

import hh.harkkas23v01.domain.ApplicationUserRepository;
import hh.harkkas23v01.domain.Article;
import hh.harkkas23v01.domain.ArticleRepository;
import hh.harkkas23v01.domain.Comment;
import hh.harkkas23v01.domain.CommentRepository;
import jakarta.validation.Valid;

@Controller
public class CommentController {
	
	@Autowired 
	private CommentRepository commentrepository;
	
	@Autowired
	private ArticleRepository articlerepository;
	
	@Autowired
	private ApplicationUserRepository applicationuserrepository;
	
	//Kommenttien listaus
	
	//Listataan KAIKKI kommentit KAIKKIIN kirjoihin
	@PreAuthorize("hasAuthority('ADMIN') or hasAuthority('USER')") //metoditason tarkistus onko oikeus poistaa
	@RequestMapping(value = {"/allComments"}) //endpoint:  http://localhost:8080/listComments
	public String listComments(Model model, @AuthenticationPrincipal UserDetails userDetails) {
		System.out.println("--- CommentController.java ---NÄYTETÄÄN KAIKKI KOMMENTIT");

		model.addAttribute("comments", commentrepository.findAll());
		
		//lisätty 24102023 kun halutaan rajata näkyvyyttä niin että käyttäjä näkee vain itse lisäämiensä kirjojen edit ja delete-napin
		//jos tätä muutetaan, niin täytyy muuttaa myös articlelist.html 
		//lisääminen ja poistaminen vaativat USER tai ADMIN-roolin
		//model.addAttribute("applicationuser", applicationuserrepository.findByUsername(userDetails.getUsername())); //lisätty 25102023
		
		return "allComments.html";	
	}


	//Listaa YHDEN kirjan kommentit kirjan id:n perusteella
	@PreAuthorize("hasAuthority('ADMIN') or hasAuthority('USER')") //metoditason tarkistus onko oikeus poistaa
	@RequestMapping(value="/article/{id}/comments", method=RequestMethod.GET)
	public String showCommentsForArticle(@PathVariable("id") Long articleId, Model model) {
		
		//Hae kommentit kirjan id:n perusteella
		List<Comment> articleComments = commentrepository.findByArticleId(articleId);
		
		System.out.println("NÄYTETÄÄN KAIKKI KOMMENTIT KIRJALLE JONKA ID: " + articleId + "---CommentContoller");
		//System.out.println(articleComments);
		
		model.addAttribute("comments", articleComments);
		
		
		return "articleComments";
	}
	
	

	//Kommenttien lisääminen kirjan id:n perusteella
	
	//Lisätään kommentti
	//Tänne ohjataan articlelist -sivulta "Add Comment"
	@PreAuthorize("hasAuthority('ADMIN') or hasAuthority('USER')") //metoditason tarkistus onko oikeus lisätä
	@RequestMapping(value="addComment/{id}")
	public String addComment(@PathVariable("id") Long id, Model model, @AuthenticationPrincipal UserDetails userDetails) {
	
		Comment comment = new Comment();
		
		comment.setArticle(articlerepository.findById(id).get());
		
		System.out.println("");
		System.out.println("KIRJA JOTA KOMMENTOIDAAN" + comment.getArticle() + "--- CommentController, addComment");
		System.out.println("KOMMENTTI: " + comment.getCommentid());

		model.addAttribute("comment", comment);
		
		System.out.println("KOMMENTTI, articleID: " + articlerepository.findById(id).get());
		model.addAttribute("applicationuser", applicationuserrepository.findByUsername(userDetails.getUsername())); //lisätty 22102023
		
		return "addComment";
	}
	
	//Tallennetaan kommentti
	//Tänne ohjataan tallennus seuraavista endpointeista:  addComment/{id}, /article/{id}/addComment/
	@PreAuthorize("hasAuthority('ADMIN') or hasAuthority('USER')") //metoditason tarkistus onko oikeus 
	@RequestMapping(value="/saveComment", method = RequestMethod.POST) //tämä käytössä addarticle.html :ssä
	public String save(@Valid Comment comment,  Article article, BindingResult bindingResult, Model model, @AuthenticationPrincipal UserDetails userDetails) {
		if (bindingResult.hasErrors()) {
			System.out.println("Some validation error happened");
			model.addAttribute("comment", comment);
			model.addAttribute("article", articlerepository.findById(comment.getArticle().getId())); // <---- tämän takia edellinen kaatui, tärkeä
			model.addAttribute("applicationuser", applicationuserrepository.findByUsername(userDetails.getUsername())); //päivitetty 22102023, käytetään addArticle.html:ssä
			return "addComment";
		}
		
		
		commentrepository.save(comment);
		
		System.out.println("LISÄTTY KOMMENTTI: " + comment + comment.getArticle());
		System.out.println("Lisääjän käyttäjätunnus: " + comment.getApplicationuser().getUsername());
		return "redirect:/allComments";
	}



	//31-10-2023
	//Lisätään kommentti, esimerkkipolku http://localhost:8080/article/3/addComment/
	//tänne ohjataan YKSITTÄISEN kirjan kommenttien listaussivulta, esim http://localhost:8080/article/8/comments "Add Comment"
	@PreAuthorize("hasAuthority('ADMIN') or hasAuthority('USER')") //metoditason tarkistus onko oikeus lisätä
	@RequestMapping(value="/article/{id}/addComment/")
	public String addCommentByArticleId(@PathVariable("id") Long id, Model model, @AuthenticationPrincipal UserDetails userDetails) {
	
		Comment comment = new Comment();
		
		comment.setArticle(articlerepository.findById(id).get());
		
		System.out.println("KIRJA JOTA KOMMENTOIDAAN" + comment.getArticle() + "--- CommentController, addComment");
		System.out.println("KOMMENTTI: " + comment.getCommentid());

		model.addAttribute("comment", comment);
		
		System.out.println("KOMMENTTI, articleID: " + articlerepository.findById(id).get());
		model.addAttribute("applicationuser", applicationuserrepository.findByUsername(userDetails.getUsername())); //lisätty 22102023
		
		return "addComment"; 
	}
	
	
	// Kommenttien lisääminen kaikkien kirjojen kaikkien kommenttien listauksesta, jolloin käyttäjä valitsee select-osiossa kommentoitavan kirjan
	
			
	//piilotettu 6.11, ei toimi oikein, muuttaa kommentoijan kirjan lisääjäksi
	//31-10-2023
	//Lisätään kommentti, esimerkkipolku http://localhost:8080/chooseArticleToComment/
	//tänne ohjataan KAIKKIEN kommentien listaussivulta
	//tässä endpointissa käyttäjä valitsee listasta, mitä kirjaa kommentoi
	/*@PreAuthorize("hasAuthority('ADMIN') or hasAuthority('USER')") //metoditason tarkistus onko oikeus lisätä
	@RequestMapping(value="chooseArticleToComment/")
	public String chooseArticleToComment(Model model, @AuthenticationPrincipal UserDetails userDetails) {
	
		model.addAttribute("comment", new Comment());
		model.addAttribute("articles", articlerepository.findAll());
		model.addAttribute("applicationuser", applicationuserrepository.findByUsername(userDetails.getUsername())); //lisätty 31-10-2023
		
		model.addAttribute("KÄYTTÄJÄ ", applicationuserrepository.findByUsername(userDetails.getUsername()) + "LISÄSI KOMMENTIN"); //lisätty 31-10-2023
		System.out.println("Endpoint: chooseArticleToComment");
		
		return "chooseAndAddComment"; //käytetään eri lomaketta, kuin yhden kirjan kommentoinneissa
	} */
	
	
	//06-11-2023
	//Lisätään kommentti valittuun kirjaan, tänne tullaan KAIKKIEN kirjojen listauksesta (choose article to comment). Esimerkkipolku http://localhost:8080/chooseArticleToComment/
	@PreAuthorize("hasAuthority('ADMIN') or hasAuthority('USER')") //metoditason tarkistus onko oikeus lisätä
	@RequestMapping(value="chooseArticleToComment/")
	public String addComment(Model model, @AuthenticationPrincipal UserDetails userDetails) {
		
		
		model.addAttribute("comment", new Comment());
		model.addAttribute("articles", articlerepository.findAll());
		model.addAttribute("applicationuser", applicationuserrepository.findByUsername(userDetails.getUsername())); //lisätty 22102023
		
		return "chooseAndAddComment"; //käytetään eri lomaketta, kuin yhden kirjan kommentoinneissa
	}
	
	//06-11-2023
	//Tallennetaan kommentti (choose article to comment)
	@PreAuthorize("hasAuthority('ADMIN') or hasAuthority('USER')") //metoditason tarkistus onko oikeus 
	@RequestMapping(value="/saveCommentToSelectedArticle", method = RequestMethod.POST) //tämä käytössä chooseAndAddComment.html :ssä
	public String save(@Valid Comment comment,  BindingResult bindingResult, Model model, @AuthenticationPrincipal UserDetails userDetails) {
		if (bindingResult.hasErrors()) {
			System.out.println("Some validation error happened");
			model.addAttribute("comment", comment);
			model.addAttribute("article", articlerepository.findById(comment.getArticle().getId())); // <---- tämän takia edellinen kaatui, tärkeä
			model.addAttribute("applicationuser", applicationuserrepository.findByUsername(userDetails.getUsername())); 
			return "chooseAndAddComment";
		}
		commentrepository.save(comment);
		System.out.println("LISÄTTY KOMMENTTI: " + comment + comment.getArticle());
		System.out.println("Lisääjän käyttäjätunnus: " + comment.getApplicationuser().getUsername());
		return "redirect:/allComments";
	}
	
	

	//Kommenttien hallinnointi, edit ja delete, vain admin
	
	//31-10-2023
	//Poista kommentti
	@PreAuthorize("hasAuthority('ADMIN')") //metoditason tarkistus onko oikeus poistaa 
	@RequestMapping(value="/deleteComment/{id}", method=RequestMethod.GET)
	public String deleteArticle(@PathVariable("id") Long commentId, Model model) {
		commentrepository.deleteById(commentId);
		System.out.println("POISTETAAN KOMMENTTI, id: " + commentId);
		return "redirect:../allComments"; 
	}
	
	//06-11-2023 Edit ei toistaiseksi tarpeellinen
	
	
	
	
	
	
	
	

}
